# 設計書一式

| 項目 | 内容 |
|------|------|
| 文書バージョン | 1.0 |
| 作成日 | 2025/07/12 |
| 作成者 | Gemini |

## 1. 画面設計書

### 1.1. 画面構成

本システムは、以下の主要な画面（ビュー）で構成される。UIはStreamlitのサイドバーで切り替える。

| 画面名 | 役割 |
|--------|------|
| ダッシュボード | タスクの監視と基本的な操作（作成・編集・削除・実行）を行うメイン画面。 |
| 実行結果ログ | 過去のタスク実行履歴を検索・閲覧する画面。 |
| サマリーレポート | システム全体の健全性をグラフで可視化する画面。 |
| 管理者設定 | システムの動作設定（PCリスト、通知設定など）を行う画面。 |

### 1.2. 主要コンポーネントと動作

- **サイドバー**: 各画面へのナビゲーションを提供する。モバイル表示ではハンバーガーメニュー内に格納される。

- **タスク一覧テーブル**: ダッシュボードのメイン要素。PC名、タスク名、状態、トリガー、次回実行日時、詳細ボタンを表示する。エラーが発生したタスクは行がハイライトされる。

- **フィルター/ソート**: ダッシュボード上で、PCグループ、アクティブ/全て、並べ替え順序を選択するウィジェットを配置する。

- **新規作成/詳細編集ダイアログ**: st.dialogを使用し、ポップアップ形式でタスクの作成・編集・削除を行う。フォームには実行タイプに応じた動的な入力欄が含まれる。

- **ログ検索パネル**: 実行結果ログ画面で、PC名、タスク名、期間などでログを絞り込むための入力フォームを配置する。

- **グラフエリア**: レポート画面で、plotlyを使い、円グラフや棒グラフで各種統計情報を表示する。

## 2. データベース設計書

### 2.1. 設計方針

- **データベース**: SQLite (単一ファイル形式: logs.db)
- **データ型**: INTEGER, TEXT を使用。日時はISO 8601形式の TEXT で保存。
- **ログ保存期間**: 当面は永続保存。将来的にアーカイブ/削除の仕組みを検討。

### 2.2. テーブル定義

#### 2.2.1. execution_logs (実行結果ログテーブル)

| カラム名 (物理名) | データ型 | 制約 | 説明 |
|-------------------|----------|------|------|
| log_id | INTEGER | PK, AI | ログを一意に識別するID |
| recorded_at | TEXT | NOT NULL | ログ記録日時 (ISO 8601) |
| pc_name | TEXT | NOT NULL | 実行PC名 |
| task_path | TEXT | NOT NULL | タスクのフォルダパス |
| task_name | TEXT | NOT NULL | タスク名 |
| result_code | INTEGER | | 実行結果コード |
| result_message | TEXT | | 実行時の出力メッセージ |
| ai_analysis | TEXT | | Gemini APIによる分析結果 |

#### 2.2.2. audit_logs (操作監査ログテーブル)

| カラム名 (物理名) | データ型 | 制約 | 説明 |
|-------------------|----------|------|------|
| audit_id | INTEGER | PK, AI | 監査ログID |
| timestamp | TEXT | NOT NULL | 操作日時 (ISO 8601) |
| user_identifier | TEXT | NOT NULL | 操作ユーザーのWindowsログオン名 |
| action_type | TEXT | NOT NULL | 操作の種類 (例: CREATE_TASK) |
| target_pc | TEXT | | 操作対象のPC名 |
| target_task | TEXT | | 操作対象のタスク名 |
| details | TEXT | | 操作の詳細 (変更前後の値などをJSONで保存) |

## 3. 外部インターフェース設計書

### 3.1. Google Chat Webhook インターフェース

- **目的**: タスク実行エラーをGoogle Chatへ通知する。
- **エンドポイント**: 管理者設定で指定されたWebhook URL。
- **メソッド**: POST
- **リクエストボディ**: CardsV2形式のJSON。PC名、タスク名、エラーコード、AI分析結果の要約を含む。

### 3.2. Gemini API インターフェース

- **目的**: エラーログを分析し、原因と対策を生成する。
- **エンドポイント**: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`
- **メソッド**: POST
- **リクエストボディ**: エラーログ情報（PC名、タスク名、エラーコード等）を含んだプロンプトをJSON形式で送信する。
- **レスポンス処理**: レスポンスJSONから分析結果テキストを抽出し、データベースに保存する。

## 4. モジュール設計書

### 4.1. モジュール構成

- **UI層**: `app.py`
- **ビジネスロジック層**: `core/task_manager.py`
- **データアクセス/外部連携層**:
  - `core/config_manager.py`
  - `core/db_manager.py`
  - `core/notification_manager.py`
  - `core/ai_analyzer.py`

### 4.2. 各モジュールの責務

#### app.py
- Streamlitアプリケーションのエントリーポイント。
- UIのレイアウト、ウィジェットの描画、画面遷移の制御。
- ユーザー操作を受け付け、対応するバックエンドモジュールを呼び出す。

#### core/config_manager.py
- `config.json`ファイルの読み書きを抽象化する。
- PCリスト、通知設定などの取得・更新メソッドを提供する。

#### core/db_manager.py
- `logs.db` (SQLite) への接続と操作を抽象化する。
- 実行ログと監査ログの追加・検索メソッドを提供する。

#### core/task_manager.py
- pywinrmライブラリを利用し、リモートPCのタスクスケジューラを操作する。
- タスクの取得、作成、編集、削除、実行のコアロジックを実装する。
- 操作に応じて監査ログの記録をdb_managerに依頼する。

#### core/notification_manager.py
- Google Chat Webhookへの通知送信処理を担う。
- config_managerからWebhook URLを取得し、整形したJSONペイロードを送信する。

#### core/ai_analyzer.py
- Gemini APIとの連携処理を担う。
- config_managerからAPIキーを取得し、エラーログを分析するためのリクエストを送信、結果を返す。