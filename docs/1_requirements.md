# 要件定義書: 複数PCタスク管理ダッシュボード

| 項目 | 内容 |
| :--- | :--- |
| **文書バージョン** | **2.0 (完成版)** |
| **作成日** | **2025/07/12** |
| **作成者** | Gemini |

---

## 1. はじめに

### 1.1. プロジェクトの背景と目的
現在、複数のPCで稼働しているタスクスケジューラの設定、実行、結果確認は、各PCに個別にリモートデスクトップ接続して手作業で行われている。この方法は非効率であり、設定ミスなどのヒューマンエラーが発生しやすい。また、どのPCでどのタスクがエラーになっているかを一覧で把握することが困難である。
本プロジェクトの目的は、これらのタスク管理業務をWebベースのダッシュボードに一元化し、業務効率の向上、作業ミスの削減、およびAIを活用した障害分析による迅速な対応を可能にすることである。

### 1.2. システム概要
本システムは、PythonのWebフレームワーク「Streamlit」を用いて構築される「複数PCタスク管理ダッシュボード」である。管理者はこのダッシュボードを通じて、ネットワーク内の複数PCに登録されているタスクスケジューラを一元的に監視、設定、実行する。タスクの実行状況はリアルタイムで確認でき、エラー発生時にはGoogle Chatへ自動で通知される。

### 1.3. 解決したい課題
- **非効率性**: 複数PCへの個別ログインと手動確認にかかる工数を削減する。
- **ヒューマンエラー**: 手作業によるタスク設定の漏れや間違いのリスクを低減する。
- **可視性の欠如**: 障害発生時に、どのPCのどのタスクが問題なのかを迅速に特定できない問題を解決する。
- **属人化**: 特定の担当者しかタスクの全体像を把握できていない状況を改善する。

### 1.4. 関係者と役割
| 役割 | 担当 | 主な責任 |
| :--- | :--- | :--- |
| **システム管理者** | (担当者名) | 本システムの開発、運用、保守。全機能へのアクセス。 |
| **一般利用者** | (利用部門/チーム) | タスクの実行状態やログの閲覧。 |

### 1.5. 用語の定義
| 用語 | 説明 |
| :--- | :--- |
| **ダッシュボード** | 本プロジェクトで開発するWebアプリケーション全体を指す。 |
| **管理サーバー** | ダッシュボード（Streamlitアプリ）が稼働するWindows Server 2019。 |
| **管理対象PC** | ダッシュボードから管理されるWindows 11 Pro搭載のPC。 |
| **WinRM** | Windows Remote Management。本システムがリモート操作に利用するプロトコル。 |
| **UNCパス** | `\\server\share`形式のネットワークパス。 |
| **NSSM** | Non-Sucking Service Manager。StreamlitアプリをWindowsサービスとして実行するために利用するツール。 |
| **Webhook URL** | Google Chatへメッセージを投稿するための専用URL。 |

---

## 2. システム要件

### 2.1. 機能要件

#### 2.1.1. タスク一覧表示機能（ダッシュボード）
- サイドバーで選択したPCグループまたは個別のPCに登録されているタスクを一覧で表示する。
- 表示するタスクは、管理者設定で指定されたフォルダパスに存在するタスクのみに限定する（デフォルトはルートフォルダ `\`）。
- ダッシュボード上に、表示を「アクティブなタスクのみ」と「すべてのタスク」で切り替えるためのボタンを配置する。
- ダッシュボード上に、タスク一覧の並べ替え順序を選択するドロップダウンリストを配置する。選択肢は「次回実行日時順」「作成日時順」などとする。
- 表示項目は「PC名」「タスク名」「状態」「トリガー」「次回実行日時」とする。
- タスクの最終実行結果がエラーの場合、該当する行をハイライト表示し、ワンクリックで関連ログにジャンプできるリンクを設ける。

#### 2.1.2. タスク手動実行・テスト実行機能
- PC名とタスク名をドロップダウンリストから選択し、即時実行する機能。
- PCを選択すると、そのPCに存在するタスクだけがリアルタイムにタスク名ドロップダウンに提案される。
- タスクの新規作成・編集後、その場で設定が正しいかを確認するための「テスト実行」ボタンを設ける。

#### 2.1.3. タスク新規作成機能（多様な実行方法に対応）
- UI上のフォームから、様々な実行方法に対応した新しいタスクを簡易に登録できる機能。
- 対象として、個別のPCだけでなく、管理者設定で定義したPCグループも選択可能とし、複数PCへの一括登録を可能にする。
- 実行タイプの選択: ユーザーはまず、「標準プログラム」「Python スクリプト」「Python スクリプト (仮想環境)」から1つを選択する。
- 選択した実行タイプに応じて、必要な入力欄が動的に表示される。
- システムは入力された情報に基づき、タスクスケジューラの「プログラム」と「引数」を自動的に設定する。
- 共通設定: 上記に加え、タスク名, 説明, 引数, 実行ユーザー, トリガー（毎日、毎週など）を設定できる。

#### 2.1.4. タスク詳細の編集・削除機能
- タスク一覧の各行に「詳細」ボタンを配置する。
- 「詳細」ボタンをクリックすると、そのタスクのすべての設定項目が入力されたポップアップウィンドウが表示される。
- ユーザーはポップアップ上で各項目を自由に編集し、「更新」ボタンを押すことで設定を保存できる。
- ポップアップ内には、タスクを削除するためのボタンも配置する。
- 削除ボタン実行時には、誤操作防止のため「本当に削除しますか？」という確認ダイアログを表示する。

#### 2.1.5. 実行結果ログ表示・検索機能
- サイドバーから専用の「実行結果ログ」画面に切り替えられる。
- ログの表示項目は「実行日時」「PC名」「タスク名」「結果」「メッセージ」「AIによる分析結果」とする。
- PC名、タスク名、期間、結果（成功/エラー）でログを絞り込む検索機能を持つ。

#### 2.1.6. 管理者設定機能
- サイドバーから専用の「管理者設定」画面に切り替えられる。
- **PCグルーピング設定**: 管理対象PCを「開発用」「本番用」などのグループにまとめる機能。
- 管理対象PCのリスト（PC名、IPアドレス、所属グループ）をUI上で閲覧・編集できる。
- タスク一覧に表示するフォルダパスを指定できる機能を追加する。
- Google Chat通知機能の有効/無効を切り替える設定を追加する。
- 通知先となるGoogle ChatのWebhook URLを登録・変更できる機能を追加する。
- **設定のバックアップ・復元機能**: システムの設定情報(JSON)とログデータベース(SQLite)をUIからダウンロード(バックアップ)・アップロード(復元)できる機能。

#### 2.1.7. エラー通知機能
- タスクの実行結果がエラーだった場合、管理者設定で指定されたGoogle ChatのWebhook URLへ通知メッセージを自動で送信する。
- 通知メッセージには、エラーが発生したPC名、タスク名、エラーコード、エラー検知日時、およびAIによる分析結果の要約を含める。
- この機能は、管理者設定で有効になっている場合にのみ動作する。

#### 2.1.8. AIによるエラー分析機能 (Gemini API活用)
- タスク実行が失敗し、エラーコードやメッセージがログに記録された際、システムは自動的にその情報をGemini APIに送信する。
- Gemini APIは、受け取ったエラー情報に基づき、「考えられる原因」と「具体的な対処法の候補」を分析し、平易な日本語のテキストを生成する。
- 生成された分析結果は、該当する実行結果ログに自動的に追記され、UI上で閲覧可能になる。

#### 2.1.9. サマリーレポート機能
- サイドバーから専用の「レポート」画面に切り替えられる。
- 以下の情報をグラフや表で可視化し、システム全体の健全性を俯瞰できるようにする。
  - 全体のタスク成功率（円グラフなど）
  - エラー発生件数の推移（時系列グラフ）
  - エラー発生回数が多いタスクのトップ5
  - エラー発生回数が多いPCのトップ5

### 2.2. 非機能要件
- **性能**: UIの各操作は原則3秒以内に応答すること。AIによる分析はバックグラウンドで非同期に実行し、UIの応答性を妨げないこと。
- **可用性**: 管理サーバーの業務時間内は常時稼働していること。NSSMを利用し、予期せぬエラー発生時も自動で再起動すること。
- **セキュリティ**:
  - ダッシュボードへのアクセスは、原則として社内ネットワークからのみに制限する。
  - リモート操作には、専用に作成した共通の管理者アカウントを使用する。
  - 「管理者設定」ページは、パスワード認証によって保護すること。
  - Google ChatのWebhook URLやその他の機密情報は、設定ファイル内では暗号化するなどの対策を検討する。
  - **操作監査ログ**: 「誰が、いつ、どのタスクを（作成/編集/削除/手動実行）したか」という操作履歴をログデータベースに記録し、追跡可能性を確保する。
- **運用・保守性**:
  - 管理対象PCのリストや通知設定は、管理者設定ページから容易に変更できること。
  - プログラムには適切なコメントを記述し、可読性を保つこと。

---

## 3. システム構成

### 3.1. 全体構成図
本システムは、以下の3つの要素で構成される。
1. **管理サーバー (司令塔)**: Windows Server 2019。Streamlitアプリが常時稼働。
2. **プログラム置き場 (NAS)**: Pythonスクリプトや関連ファイルを一元管理。
3. **管理対象PC (実行部隊)**: Windows 11 Pro。サーバーからの命令を受け、タスクスケジューラを操作。

### 3.2. ソフトウェア構成
| 役割 | OS | 主要ソフトウェア |
| :--- | :--- | :--- |
| 管理サーバー | Windows Server 2019 | Python, Streamlit, pywinrm, pandas, NSSM |
| 管理対象PC | Windows 11 Pro | Python, 必要なライブラリ |
| NAS | (各社OS) | - |

### 3.3. ハードウェア構成
- **管理サーバー**: 標準的なサーバースペックで可。特別な要件はなし。
- **管理対象PC**: 標準的なデスクトップスペックで可。特別な要件はなし。

### 3.4. ネットワーク構成
- 全ての機器は同一のローカルネットワークに接続されていること。
- 管理サーバー、NASは固定IPアドレスで運用することが望ましい。
- ファイアウォールでWinRMの通信（TCPポート: 5985）が許可されていること。

### 3.5. データ管理
- **設定データ**: PCリスト、PCグループ、表示フォルダパス、通知設定などの情報は、NAS上に`JSON`形式のファイルとして保持する。
- **ログデータベース**: タスクの実行履歴、およびダッシュボードの操作監査ログは、NAS上に`SQLite`データベースファイルとして保持する。

---

## 4. その他

### 4.1. 制約事項・前提条件
- **管理対象PCはWindows 11 Pro以上であること (Homeエディションは不可)。**
- 全ての管理対象PCで、WinRMが有効化されていること。
- 全ての管理対象PCで、リモート操作用の共通管理者アカウントが作成されていること。
- スクリプトやプログラムのパス指定は、全てUNCパスで行うこと。
- ダッシュボードの実行は、原則として管理サーバー上で行う。

### 4.2. スケジュール（案）
| フェーズ | 期間（目安） | 主な作業内容 |
| :--- | :--- | :--- |
| **環境構築** | 1週間 | WinRM有効化、共通アカウント作成、サーバー設定、ライブラリ導入 |
| **開発** | 2週間 | Pythonスクリプト、Streamlit UIの開発 |
| **テスト** | 1週間 | 機能テスト、複数PCでの接続テスト |
| **リリース・運用開始** | - | NSSMによるサービス化、利用者への展開 |